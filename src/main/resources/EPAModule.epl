module EPAModule;

//import event classes
import de.hsaugsburg.cep.model.*; 

/*
TODO generate useful event id for all events
*/

@Name("AllSensorEvents")
@Description("Detects all sensor events")
select * from SensorEvent;

@Name("DetectMoveEvent")
@Description("Detects a movement of a component")
insert into ItemMovedEvent
select 'TestMoveEvent' as eventId,
	toSensor.timestamp as timestamp,
	'SomeItem' as itemId,
	fromSensor.sensorId as sourceId,
	toSensor.sensorId as targetId
	from pattern[every fromSensor=SensorEvent(state=false) -> toSensor=SensorEvent(state=true)]
	where isNeighbour(fromSensor.sensorId, toSensor.sensorId);
	//TODO Ereignisse konsumieren oder Zeitfenster? eventId und itemId korrekt vergeben
	
@Name("DetectItemsChangedEvent")
@Description("Detects when a work item enters or leaves the industrial plant.")
insert into ItemsChangedEvent
select 'NewItemsChangedEvent' as eventId,
	event.timestamp as timestamp,
	'SomeItem' as itemId,
	getChangeSensorType(sensor.sensorId) as changeType
	from pattern[every sensor=SensorEvent(state=true)]
	where isChangeSensor(sensor.sensorId);

@Name("DetectWorkEvent")
@Description("Detects when a work item is being in manufactured by a machine.")
insert into WorkEvent
select 'NewWorkEvent' as eventId,
	event.timestamp as timestamp,
	'SomeItem' as itemId,
	getMachineId(sensor.sensorId) as workerId,
	getMachineWorkType(sensor.sensorId) as work
	from pattern[every sensor=SensorEvent(state=true)]
	where isMachineSensor(sensor.sensorId);

@Name("AllMoveEvents")
@Description("Listens to all new ItemMovedEvent")
select * from ItemMovedEvent;
